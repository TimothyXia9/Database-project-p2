# 用户权限与操作文档

## 系统用户角色

本系统包含三种用户角色：

-   **Customer（观众）** - 普通观众用户，默认角色
-   **Employee（员工）** - 内容管理员工
-   **Admin（管理员）** - 系统管理员

---

## 1. Customer（观众）权限

### 🟢 允许的操作

#### 账户管理

-   ✅ 注册新账户
-   ✅ 登录/登出
-   ✅ 查看个人账户信息
-   ✅ 修改个人资料（姓名、地址、邮箱等）
-   ✅ 修改密码

#### 剧集浏览

-   ✅ 浏览所有网络剧集列表
-   ✅ 搜索剧集（按标题、类型）
-   ✅ 查看剧集详情
-   ✅ 查看剧集集数列表
-   ✅ 查看剧集播出时间表（Telecast）
-   ✅ 查看剧集评分和评论

#### 反馈功能

-   ✅ 对网络剧集提交反馈
    -   每部剧集只能提交一次反馈
    -   包含评分（1-5 分）和文字评论
-   ✅ 查看自己提交的反馈
-   ✅ 修改自己的反馈
-   ❌ 删除反馈（仅 Admin 可删除）

#### 制作信息查看

-   ✅ 查看制作公司信息
-   ✅ 查看制片人信息
-   ✅ 查看剧集合同信息（只读）

### 🔴 不允许的操作

-   ❌ 创建、修改、删除剧集
-   ❌ 创建、修改、删除集数
-   ❌ 创建、修改、删除制作公司
-   ❌ 创建、修改、删除制片人
-   ❌ 修改合同信息
-   ❌ 删除其他用户的反馈
-   ❌ 修改账户类型
-   ❌ 访问管理后台

---

## 2. Employee（员工）权限

### 🟢 允许的操作

#### 继承 Customer 的所有权限

-   ✅ 所有观众可以进行的操作

#### 剧集管理

-   ✅ 创建新的网络剧集
-   ✅ 修改剧集信息（标题、类型、集数等）
-   ✅ 查看所有剧集详细信息
-   ❌ 删除剧集（仅 Admin）

#### 集数管理

-   ✅ 为剧集添加新集数
-   ✅ 修改集数信息（标题、时长、发布日期等）
-   ✅ 管理集数的播出时间表（Telecast）
    -   设置开始/结束时间
    -   记录观看人数
    -   标记技术中断
-   ❌ 删除集数（仅 Admin）

#### 制作公司管理

-   ✅ 添加新的制作公司
-   ✅ 修改制作公司信息（名称、地址、成立年份等）
-   ✅ 查看制作公司详细信息
-   ❌ 删除制作公司（仅 Admin）

#### 制片人管理

-   ✅ 添加新的制片人
-   ✅ 修改制片人信息（姓名、联系方式、地址等）
-   ✅ 管理制片人与制作公司的关联关系
    -   添加新的关联
    -   设置/修改关联开始日期
    -   设置关联结束日期
-   ❌ 删除制片人（仅 Admin）

#### 合同管理

-   ✅ 创建新的剧集合同
-   ✅ 修改合同信息
    -   合同状态（Active, Expired, Terminated, Pending）
    -   单集费用
    -   合同期限
-   ✅ 查看所有合同详情
-   ❌ 删除合同（仅 Admin）

#### 语言配置管理

-   ✅ 为剧集添加配音语言
-   ✅ 为剧集添加字幕语言
-   ✅ 修改语言配置
-   ❌ 删除语言配置（仅 Admin）

#### 发行管理

-   ✅ 配置剧集发行国家
-   ✅ 设置各国家的发行日期
-   ✅ 修改发行信息
-   ❌ 删除发行记录（仅 Admin）

#### 反馈管理（有限）

-   ✅ 查看所有用户反馈
-   ❌ 删除反馈（仅 Admin）

### 🔴 不允许的操作

-   ❌ 删除任何实体（剧集、集数、制作公司、制片人、合同等）
-   ❌ 修改用户账户类型
-   ❌ 删除用户账户
-   ❌ 访问系统级别的管理功能

---

## 3. Admin（管理员）权限

### 🟢 允许的操作

#### 拥有所有权限

-   ✅ **Customer 和 Employee 的所有权限**

#### 删除权限

-   ✅ 删除网络剧集
-   ✅ 删除集数
-   ✅ 删除制作公司
-   ✅ 删除制片人
-   ✅ 删除合同
-   ✅ 删除语言配置
-   ✅ 删除发行记录
-   ✅ 删除用户反馈

#### 用户管理

-   ✅ 查看所有用户账户
-   ✅ 修改用户账户类型（Customer ↔ Employee ↔ Admin）
-   ✅ 激活/禁用用户账户
-   ✅ 删除用户账户
-   ✅ 重置用户密码

#### 系统管理

-   ✅ 查看系统统计信息
-   ✅ 管理国家列表
-   ✅ 执行数据库维护操作
-   ✅ 查看系统日志

---

## 4. 公开访问（未登录用户）

### 🟢 允许的操作

-   ✅ 浏览剧集列表（有限信息）
-   ✅ 查看剧集基本详情
-   ✅ 搜索剧集
-   ✅ 注册新账户
-   ✅ 登录

### 🔴 不允许的操作

-   ❌ 查看完整剧集详情
-   ❌ 查看集数列表
-   ❌ 提交反馈
-   ❌ 任何写入操作

---

## 5. API 端点权限总结

### 公开端点（无需认证）

```
GET  /api/series                    # 浏览剧集列表
GET  /api/series/:id                # 查看剧集详情
GET  /api/production-houses         # 查看制作公司列表
GET  /api/production-houses/:id     # 查看制作公司详情
GET  /api/producers                 # 查看制片人列表
GET  /api/producers/:id             # 查看制片人详情
POST /api/auth/register             # 注册
POST /api/auth/login                # 登录
```

### Customer 端点（需要认证）

```
GET  /api/auth/me                   # 获取当前用户信息
POST /api/feedback                  # 提交反馈
PUT  /api/feedback/:id              # 修改自己的反馈
GET  /api/feedback                  # 查看自己的反馈
```

### Employee 端点（Employee/Admin）

```
POST   /api/series                  # 创建剧集
PUT    /api/series/:id              # 修改剧集
POST   /api/episodes                # 添加集数
PUT    /api/episodes/:id            # 修改集数
POST   /api/production-houses       # 添加制作公司
PUT    /api/production-houses/:id   # 修改制作公司
POST   /api/producers               # 添加制片人
PUT    /api/producers/:id           # 修改制片人
POST   /api/contracts               # 创建合同
PUT    /api/contracts/:id           # 修改合同
POST   /api/telecasts               # 添加播出时间
PUT    /api/telecasts/:id           # 修改播出时间
```

### Admin 端点（仅 Admin）

```
DELETE /api/series/:id              # 删除剧集
DELETE /api/episodes/:id            # 删除集数
DELETE /api/production-houses/:id   # 删除制作公司
DELETE /api/producers/:id           # 删除制片人
DELETE /api/contracts/:id           # 删除合同
DELETE /api/feedback/:id            # 删除反馈
DELETE /api/telecasts/:id           # 删除播出时间
PUT    /api/users/:id/role          # 修改用户角色
DELETE /api/users/:id               # 删除用户
```

---

## 6. 业务规则约束

### 反馈规则

-   ✅ 每个用户对每部剧集只能提交一次反馈
-   ✅ 评分必须在 1-5 之间
-   ✅ 反馈文本最长 128 字符
-   ✅ 只能修改自己的反馈（Admin 可删除所有反馈）

### 合同规则

-   ✅ 合同期限为一年（从签订日期起算）
-   ✅ 合同可以逐年续约
-   ✅ 单集费用必须大于 0
-   ✅ 合同状态：Active, Expired, Terminated, Pending

### 制片人关联规则

-   ✅ 制片人可以关联多个制作公司
-   ✅ 制作公司可以关联多个制片人
-   ✅ 关联必须有开始日期
-   ✅ 结束日期可以为空（表示当前仍在职）
-   ✅ 结束日期必须晚于或等于开始日期

### 播出时间规则

-   ✅ 结束时间必须晚于开始时间
-   ✅ 观看人数必须 >= 0
-   ✅ 技术中断标记：'Y' 或 'N'

### 数据完整性规则

-   ✅ 制片人邮箱必须唯一
-   ✅ 观众账户邮箱必须唯一
-   ✅ 一个剧集对应一个制作公司
-   ✅ 删除剧集会级联删除其集数、合同、反馈等

---

## 7. 前端页面访问权限

### 公开页面

-   **首页** `/` - 所有人可访问
-   **登录页** `/login` - 未登录用户
-   **注册页** `/register` - 未登录用户
-   **剧集浏览** `/browse` - 所有人可访问
-   **剧集详情** `/series/:id` - 所有人可访问

### 需要登录的页面

-   **用户面板** `/dashboard` - Customer/Employee/Admin
    -   Customer: 查看个人信息、我的反馈
    -   Employee: + 内容管理功能
    -   Admin: + 用户管理、系统管理

### Employee 专属功能

-   **内容管理面板** - 管理剧集、集数、制作公司、制片人
-   **合同管理面板** - 管理剧集合同
-   **播出管理面板** - 管理播出时间表

### Admin 专属功能

-   **用户管理面板** - 管理所有用户账户
-   **系统设置面板** - 系统级别配置
-   **数据统计面板** - 查看系统数据统计

---

## 8. 实施建议

### 前端实现

1. 使用 Redux 存储用户角色信息
2. 创建 `ProtectedRoute` 组件检查权限
3. 根据用户角色动态显示/隐藏功能按钮
4. 在操作前验证用户权限

### 后端实现

1. 使用装饰器 `@jwt_required()` 保护需要认证的端点
2. 使用自定义装饰器 `@role_required(['Employee', 'Admin'])` 检查角色
3. 在删除操作中增加 `@role_required(['Admin'])` 限制
4. 对所有写入操作进行权限验证

### 安全考虑

1. ✅ 所有密码使用 bcrypt 加密
2. ✅ JWT Token 有效期设置（1 小时 access token）
3. ✅ 使用 Refresh Token 机制（30 天）
4. ✅ SQL 注入防护（使用 ORM）
5. ✅ XSS 防护（React 自动转义 + DOMPurify）
6. ✅ CORS 配置限制
7. ✅ 输入验证（Marshmallow schemas）
